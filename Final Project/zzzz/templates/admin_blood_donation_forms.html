{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">ðŸ©¸ Quick Medical Screening</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6>Request Details:</h6>
                        <p><strong>Blood Group Needed:</strong> {{ blood_request.data.blood_group_needed }}</p>
                        <p><strong>Hospital:</strong> {{ admin.hospital_name }}</p>
                        <p><strong>Address:</strong> {{ admin.address }}</p>
                    </div>

                    <form id="bloodDonationForm">
                        <input type="hidden" id="requestId" value="{{ request_id }}">

                        <!-- Essential Medical Questions Only -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Medical Screening Questions</h5>
                                <small>Please answer honestly - your safety is our priority</small>
                            </div>
                            <div class="card-body">
                                <!-- Question 1 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">1. Are you feeling healthy and well today?
                                        *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="healthyToday" id="healthyYes"
                                            value="yes" required>
                                        <label class="btn btn-outline-success" for="healthyYes">âœ“ Yes</label>
                                        <input type="radio" class="btn-check" name="healthyToday" id="healthyNo"
                                            value="no" required>
                                        <label class="btn btn-outline-danger" for="healthyNo">âœ— No</label>
                                    </div>
                                </div>

                                <!-- Question 2 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">2. Do you have any chronic illness (diabetes,
                                        heart disease, cancer, etc.)? *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="chronicIllness" id="chronicYes"
                                            value="yes" required>
                                        <label class="btn btn-outline-danger" for="chronicYes">âœ— Yes</label>
                                        <input type="radio" class="btn-check" name="chronicIllness" id="chronicNo"
                                            value="no" required>
                                        <label class="btn btn-outline-success" for="chronicNo">âœ“ No</label>
                                    </div>
                                </div>

                                <!-- Question 3 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">3. Have you been diagnosed with HIV, Hepatitis
                                        B/C, or other infectious diseases? *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="infectiousDiseases"
                                            id="infectiousYes" value="yes" required>
                                        <label class="btn btn-outline-danger" for="infectiousYes">âœ— Yes</label>
                                        <input type="radio" class="btn-check" name="infectiousDiseases"
                                            id="infectiousNo" value="no" required>
                                        <label class="btn btn-outline-success" for="infectiousNo">âœ“ No</label>
                                    </div>
                                </div>

                                <!-- Question 4 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">4. Are you currently taking any medications?
                                        *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="currentMedicines" id="medicinesYes"
                                            value="yes" required>
                                        <label class="btn btn-outline-warning" for="medicinesYes">âš  Yes</label>
                                        <input type="radio" class="btn-check" name="currentMedicines" id="medicinesNo"
                                            value="no" required>
                                        <label class="btn btn-outline-success" for="medicinesNo">âœ“ No</label>
                                    </div>
                                </div>

                                <!-- Question 5 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">5. Have you donated blood in the last 3 months?
                                        *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="recentDonation" id="donationYes"
                                            value="yes" required>
                                        <label class="btn btn-outline-danger" for="donationYes">âœ— Yes</label>
                                        <input type="radio" class="btn-check" name="recentDonation" id="donationNo"
                                            value="no" required>
                                        <label class="btn btn-outline-success" for="donationNo">âœ“ No</label>
                                    </div>
                                </div>

                                <!-- Question 6 - For Women Only -->
                                <div class="mb-4" id="womenQuestion" style="display: none;">
                                    <label class="form-label fw-bold">6. Are you currently pregnant or breastfeeding?
                                        *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="pregnantBreastfeeding"
                                            id="pregnantYes" value="yes">
                                        <label class="btn btn-outline-danger" for="pregnantYes">âœ— Yes</label>
                                        <input type="radio" class="btn-check" name="pregnantBreastfeeding"
                                            id="pregnantNo" value="no">
                                        <label class="btn btn-outline-success" for="pregnantNo">âœ“ No</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Consent -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="consentTerms" required>
                                    <label class="form-check-label" for="consentTerms">
                                        <strong>I confirm that the above information is true and I voluntarily consent
                                            to donate blood. *</strong>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-danger btn-lg px-5">
                                <i class="fas fa-check-circle me-2"></i>Submit
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check if user is female from session/profile and show women's question
    fetch('/api/user/profile')
        .then(response => response.json())
        .then(data => {
            if (data.gender === 'female') {
                document.getElementById('womenQuestion').style.display = 'block';
                document.querySelector('input[name="pregnantBreastfeeding"]').required = true;
            }
        })
        .catch(error => console.log('Could not fetch gender'));

    // Form submission
    document.getElementById('bloodDonationForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // Collect simplified form data
        const formData = {
            request_id: document.getElementById('requestId').value,
            medical_screening: {
                healthy_today: document.querySelector('input[name="healthyToday"]:checked')?.value,
                chronic_illness: document.querySelector('input[name="chronicIllness"]:checked')?.value,
                infectious_diseases: document.querySelector('input[name="infectiousDiseases"]:checked')?.value,
                current_medicines: document.querySelector('input[name="currentMedicines"]:checked')?.value,
                recent_donation: document.querySelector('input[name="recentDonation"]:checked')?.value,
                pregnant_breastfeeding: document.querySelector('input[name="pregnantBreastfeeding"]:checked')?.value
            },
            consent: document.getElementById('consentTerms').checked
        };

        // Validate consent
        if (!formData.consent) {
            alert('Please check the consent checkbox.');
            return;
        }

        // Submit form
        fetch('/user/submit_blood_donation_form', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ“ Form submitted successfully! Thank you for your willingness to donate.');
                    window.location.href = '/dashboard';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting form. Please try again.');
            });
    });
</script>
{% endblock %}